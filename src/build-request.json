{
  "kind": "build_request",
  "title": "Fix Room Details page loading failure and ensure devices can be added to rooms reliably",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Improve Room Details page error handling so the page remains usable when backend calls fail (including the case where the backend canister is stopped) and provides a clear recovery path.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4",
          "msg-9",
          "msg-11"
        ],
        "quotes": [
          "بيحصل ايرور Failed to Load Room",
          "عدله لكي تعمل الصفحة بشكل طبيعي",
          "اصلح الكود ليجعل الصفحه تعمل واستطيع اضافة اجهزة داخل الغرف"
        ]
      },
      "acceptanceCriteria": [
        "When getRoomInfo fails, the Room Details page shows an English error message that distinguishes backend-unavailable/canister-stopped style failures from generic failures (no raw CBOR or request dump shown to the user).",
        "The error UI provides at least: (a) a 'Try Again' action that re-runs the query, and (b) a 'Back to Rooms' action that always works.",
        "If the error appears to be a canister-stopped/unavailable scenario (e.g., reject code 5 / IC0508 in the error text), the UI includes concise English guidance (e.g., backend unavailable; try again later/reload) instead of only the raw error message.",
        "No unhandled exceptions occur in RoomDetailsPage when room is null or query errors."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Make adding devices to a room reliable by eliminating client-side timestamp-based device ID generation and replacing it with a backend-provided unique device ID allocation flow.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-11"
        ],
        "quotes": [
          "اصلح الكود ليجعل الصفحه تعمل واستطيع اضافة اجهزة داخل الغرف"
        ]
      },
      "acceptanceCriteria": [
        "Backend: add a new public method that returns a unique DeviceId for the caller (e.g., by scanning existing device IDs for that user and selecting the next available value in the 0–255 range).",
        "Backend: createDevice continues to work as-is, but the new ID allocation guarantees that repeated adds (including rapid bulk adds) do not collide with existing IDs for that user.",
        "Frontend: CreateDeviceDialog and BulkAddDevicesDialog no longer use Date.now()%256 (or similar) to pick device IDs; they request IDs from the backend allocator before calling createDevice.",
        "Bulk add allocates a fresh ID per device creation and successfully creates N devices in one operation without ID collisions.",
        "If the allocator cannot provide an ID (e.g., user already has 256 devices), the frontend shows a clear English error and does not attempt to call createDevice with a guessed ID."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Ensure the Room Details device list updates immediately after adding devices so users can confirm devices were added to the selected room.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-11"
        ],
        "quotes": [
          "...واستطيع اضافة اجهزة داخل الغرف"
        ]
      },
      "acceptanceCriteria": [
        "After a successful add (single or bulk), the RoomDeviceListSection reflects the newly created devices without requiring a manual page refresh (via React Query invalidation/refetch already used by createDevice mutation, or an explicit refetch on dialog close).",
        "After adding devices, the empty-state 'No Devices Yet' is replaced by the actual device cards for the room.",
        "The add-device dialogs close on success and leave the Room Details page in a usable state (no stuck loading spinners)."
      ]
    }
  ],
  "constraints": [
    "Do not edit files under frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, or anything in frontend/src/components/ui (compose existing components instead).",
    "Backend must remain a single Motoko actor in backend/main.mo; only add migration.mo if a state upgrade is strictly required (it should not be for adding a new method)."
  ],
  "nonGoals": [
    "Starting/stopping the canister programmatically from within the app (not possible from application code).",
    "Adding third-party authentication or any external database."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}