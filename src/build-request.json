{
  "kind": "build_request",
  "title": "Auto-provision authenticated principals as 'user' role to prevent Rooms Unauthorized error",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-6",
      "text": "Add a backend flow that automatically provisions an authenticated caller with the '#user' role on first login/first use, so that newly signed-in users do not hit \"Unauthorized: Must have user role\" when loading Rooms.",
      "target": "backend",
      "source": {
        "messageIds": [
          "recent-messages"
        ],
        "quotes": [
          "Failed to Load Rooms\nUnauthorized: Must have user role",
          "ايوة عدلو"
        ]
      },
      "acceptanceCriteria": [
        "When a previously unseen authenticated principal interacts with the canister for the first time, the principal is granted the '#user' role automatically.",
        "The provisioning flow must not grant roles to the anonymous principal.",
        "Existing role assignments (including admins) continue to work unchanged.",
        "After provisioning, calling existing user-gated endpoints (e.g., getAllRoomSummaries/getAllRooms/getAllDevices) succeeds for the new user without returning \"Unauthorized: Must have user role\"."
      ]
    },
    {
      "id": "REQ-7",
      "text": "Expose a backend shared method that the frontend can call immediately after Internet Identity login to trigger user auto-provisioning (because Rooms list endpoints are query calls and cannot mutate state).",
      "target": "backend",
      "source": {
        "messageIds": [
          "recent-messages"
        ],
        "quotes": [
          "أول ما تدخل، الـ backend بيحتاج يسجّلك تلقائيًا كـ user."
        ]
      },
      "acceptanceCriteria": [
        "A new shared backend method exists that (1) checks whether caller already has '#user', (2) if not, grants '#user', and (3) is safe to call multiple times (idempotent).",
        "If the caller is anonymous, the method rejects/traps with a clear Unauthorized error."
      ]
    },
    {
      "id": "REQ-8",
      "text": "Update the frontend to call the new provisioning method once after successful authentication (Internet Identity) and before triggering Rooms-related React Query fetches, so that the Rooms page can load successfully for first-time users without manual retries.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-messages"
        ],
        "quotes": [
          "Fix Rooms page not opening… Unauthorized: Must have user role",
          "ايوة"
        ]
      },
      "acceptanceCriteria": [
        "After logging in with Internet Identity, the app triggers the provisioning call once per session (or once per actor creation) and does not spam repeated calls on re-render.",
        "Navigating to the Rooms view after first login loads the rooms list instead of showing the Unauthorized error screen.",
        "If provisioning fails, the UI surfaces a clear error state and still allows the user to retry provisioning and then re-fetch Rooms."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor in backend/main.mo.",
    "Do not modify any files under frontend/src/hooks/useActor.ts, frontend/src/hooks/useInternetIdentity.ts(x), or frontend/src/main.tsx (immutable paths).",
    "User-facing text added/updated in the UI must be in English."
  ],
  "nonGoals": [
    "Implementing third-party authentication providers (only Internet Identity).",
    "Adding new databases or external persistence layers.",
    "Changing the existing admin-only restrictions for creating rooms/devices."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}