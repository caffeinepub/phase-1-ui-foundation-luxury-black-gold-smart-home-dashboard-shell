{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Harden Room Details loading and make device adding + refresh reliable",
  "requirements": [
    {
      "id": "REQ-1",
      "summary": "Make Room Details resilient to backend failures with clear, actionable recovery UI and no raw error dumps.",
      "acceptanceCriteria": [
        "When getRoomInfo fails, the Room Details page shows an English error message that distinguishes backend-unavailable/canister-stopped style failures from generic failures (no raw CBOR or request dump shown to the user).",
        "The error UI provides at least: (a) a 'Try Again' action that re-runs the query, and (b) a 'Back to Rooms' action that always works.",
        "If the error appears to be a canister-stopped/unavailable scenario (e.g., reject code 5 / IC0508 in the error text), the UI includes concise English guidance (e.g., backend unavailable; try again later/reload) instead of only the raw error message.",
        "No unhandled exceptions occur in RoomDetailsPage when room is null or query errors."
      ],
      "file_operations": [
        {
          "path": "frontend/src/utils/backendAvailability.ts",
          "operation": "create",
          "description": "Add a small helper to sanitize backend errors into user-friendly English messages and to detect canister-stopped/unavailable patterns (e.g., IC0508, reject code 5) without exposing raw request/CBOR dumps."
        },
        {
          "path": "frontend/src/pages/RoomDetailsPage.tsx",
          "operation": "modify",
          "description": "Use the new backend error sanitizer to render a safe, clear error state that distinguishes canister-unavailable vs generic failures, keeps the page usable, and always offers both 'Try Again' (refetch) and 'Back to Rooms'. Compose existing shadcn-ui Button/Card primitives already used on the page; verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-2",
      "summary": "Replace client-side timestamp DeviceId generation with backend-allocated IDs for single and bulk device creation, with clear failure handling.",
      "acceptanceCriteria": [
        "Backend: add a new public method that returns a unique DeviceId for the caller (e.g., by scanning existing device IDs for that user and selecting the next available value in the 0â€“255 range).",
        "Backend: createDevice continues to work as-is, but the new ID allocation guarantees that repeated adds (including rapid bulk adds) do not collide with existing IDs for that user.",
        "Frontend: CreateDeviceDialog and BulkAddDevicesDialog no longer use Date.now()%256 (or similar) to pick device IDs; they request IDs from the backend allocator before calling createDevice.",
        "Bulk add allocates a fresh ID per device creation and successfully creates N devices in one operation without ID collisions.",
        "If the allocator cannot provide an ID (e.g., user already has 256 devices), the frontend shows a clear English error and does not attempt to call createDevice with a guessed ID."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Add a React Query mutation/hook that requests a backend-allocated next DeviceId (via the existing backend actor capability generateNextDeviceId) and exposes it for dialogs to call before createDevice."
        },
        {
          "path": "frontend/src/components/rooms/CreateDeviceDialog.tsx",
          "operation": "modify",
          "description": "Remove timestamp-based DeviceId generation and request a backend-allocated DeviceId before calling createDevice. If allocation fails (e.g., exhausted IDs), show a concise English error and do not call createDevice. Keep dialog behavior consistent (disable while pending, close on success) using existing shadcn-ui Dialog/Button/Input components; verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/rooms/BulkAddDevicesDialog.tsx",
          "operation": "modify",
          "description": "Remove timestamp-based DeviceId generation and allocate a fresh backend-provided DeviceId for each device in the bulk loop before calling createDevice. If allocation fails mid-run, stop further creates and show a clear English error (no guessed IDs). Use existing shadcn-ui Dialog/Button/Input/ScrollArea components; verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-3",
      "summary": "Refresh the Room Details device list immediately after successful device add (single or bulk) and avoid stuck loading states.",
      "acceptanceCriteria": [
        "After a successful add (single or bulk), the RoomDeviceListSection reflects the newly created devices without requiring a manual page refresh (via React Query invalidation/refetch already used by createDevice mutation, or an explicit refetch on dialog close).",
        "After adding devices, the empty-state 'No Devices Yet' is replaced by the actual device cards for the room.",
        "The add-device dialogs close on success and leave the Room Details page in a usable state (no stuck loading spinners)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/rooms/CreateDeviceDialog.tsx",
          "operation": "modify",
          "description": "Add an optional success callback (e.g., onSuccess) that is invoked after a successful create + dialog close so the parent can immediately refetch room devices, ensuring the list updates without refresh. Use existing shadcn-ui primitives; verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/rooms/BulkAddDevicesDialog.tsx",
          "operation": "modify",
          "description": "Add an optional success callback (e.g., onSuccess) that is invoked after all devices are created and the dialog closes, so the parent can immediately refetch room devices and replace the empty state. Use existing shadcn-ui primitives; verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/rooms/RoomDeviceListSection.tsx",
          "operation": "modify",
          "description": "Wire dialog success callbacks to refetch the room-scoped devices query (and/or invalidate the ['devices', roomId] query) so newly created device cards appear immediately and the page remains usable. Compose existing shadcn-ui Buttons/Dialogs; verify the component's usage instructions before implementing."
        }
      ]
    }
  ]
}