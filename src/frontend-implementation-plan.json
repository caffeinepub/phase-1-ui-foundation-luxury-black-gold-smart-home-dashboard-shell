{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Frontend auto-provisioning call after Internet Identity login to prevent Rooms unauthorized errors",
  "requirements": [
    {
      "id": "REQ-8",
      "summary": "Trigger user auto-provisioning once after Internet Identity authentication and gate Rooms React Query fetches until provisioning completes, with clear retry UI on failure.",
      "acceptanceCriteria": [
        "After logging in with Internet Identity, the app triggers the provisioning call once per session (or once per actor creation) and does not spam repeated calls on re-render.",
        "Navigating to the Rooms view after first login loads the rooms list instead of showing the Unauthorized error screen.",
        "If provisioning fails, the UI surfaces a clear error state and still allows the user to retry provisioning and then re-fetch Rooms."
      ],
      "file_operations": [
        {
          "path": "frontend/src/backend.d.ts",
          "operation": "modify",
          "description": "Update the typed backend interface to include the new backend provisioning method introduced by REQ-7 so the frontend can call it without type errors (keep naming aligned with the backend capability)."
        },
        {
          "path": "frontend/src/hooks/useAutoProvisionUser.ts",
          "operation": "create",
          "description": "Create a React hook that uses existing auth/actor hooks to call the new backend provisioning method exactly once per actor creation when the user is authenticated (idempotent), exposes status (idle/loading/success/error), and provides an explicit retry function for the UI. Use React Query mutation for request state and ensure it does not run for unauthenticated sessions. Use patterns from the selected 'authorization' component for handling auth state and surfacing authorization trap messages. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Add optional query-control parameters (e.g., an `enabled` override) to Rooms-related React Query hooks (starting with `useGetAllRoomSummaries`) so Rooms fetches can be deferred until provisioning succeeds, without changing immutable auth/actor hooks."
        },
        {
          "path": "frontend/src/pages/RoomsPage.tsx",
          "operation": "modify",
          "description": "Integrate the provisioning hook to gate the rooms list query until provisioning has succeeded. If provisioning fails, show an English error state with a \"Retry setup\" action that re-runs provisioning and then triggers a rooms refetch; avoid showing the existing unauthorized error screen when the fixable provisioning failure is the cause. Use existing shadcn/ui-based UI patterns already present (Button/Card/GlassCard usage) for consistent styling. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Wire the provisioning hook at the app shell level (after unlock) so provisioning is triggered immediately after successful Internet Identity authentication/actor creation (before the user navigates to Rooms), while still avoiding repeated calls on re-renders."
        }
      ]
    }
  ]
}